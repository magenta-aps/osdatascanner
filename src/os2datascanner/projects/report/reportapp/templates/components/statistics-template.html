<div class="content">
  {% if url_param == 'leader' %}
  <h1 class="page-title">Lederstatistik</h1>
  {% elif url_param == 'dpo' %}
  <h1 class="page-title">DPO statistik</h1>
  {% endif %}
  <div class="statistic_wrapper">

    <!-- Bar chart -->
    <div class="statistic statistic--one">
      <div class="statistic_header">
        <div class="">
          <h1 class="page-title__sub">Medarbejderoverblik</h1>
          <p class="chart_description">Overblik over afdelinger med flest uhåndterede matches</p>
          <p class="hidden chart_description">Overblik over afdelinger med ældste matches</p>
        </div>
        <div class="statistic_header_nav">
          <div style="display:grid;"> <!-- Display grid just for moving <a> tag to the right --> 
            <a href="">Se alle</a>
          </div>
          <div class="dropdown">
            <div class="select">
              <span class="select_span">Uhåndterede matches</span>
              <i class="material-icons">
                keyboard_arrow_down
              </i>
            </div>
            <ul class="dropdown-menu">
              <li>Uhåndterede matches</li>
              <li>Ældste matches</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="bar_chart_container chart_container">
        <canvas id="bar_chart_unhandled"></canvas>
      </div>
      <div class="hidden bar_chart_container chart_container">
        <canvas id="bar_chart_oldest"></canvas>
      </div>
    </div>

    <!-- Pie chart -->
    <div class="statistic statistic--two">
      <div class="statistic_header">
        <div>
          <h1 class="page-title__sub">Fordeling af matches</h1>
          <p class="chart_description">Matches fordelt på følsomheder</p>
          <p class="hidden chart_description">Matches fordelt på datakilder</p>
        </div>
        <div class="statistic_header_nav">
            <div></div>
            <div class="dropdown">
              <div class="select">
                <span class="select_span">Følsomheder</span>
                <i class="material-icons">
                  keyboard_arrow_down
                </i>
              </div>
              <ul class="dropdown-menu">
                <li>Følsomheder</li>
                <li>Datakilder</li>
              </ul>
            </div>
        </div>
      </div>
      <div class="pie_chart_container chart_container">
        <div>
          <canvas id="pie_chart_sensitivity" width="100" height="100"></canvas>
        </div>
        <div id="pie_legend_sensitivity"></div>
      </div>
      <div class="hidden pie_chart_container chart_container">
        <div>
          <canvas id="pie_chart_datasources" width="100" height="100"></canvas>
        </div>
        <div id="pie_legend_datasources"></div>
      </div>
    </div>
  </div>

  <div class="statistic_wrapper">

    <!-- Doughnut chart -->
    <div class="statistic statistic--three">
      <div class="statistic_header">
        <div>
          <h1 class="page-title__sub">Håndterede matches</h1>
          <p class="chart_description">Procentvis andel af håndterede matches fordelt på følsomhed</p>
          <p class="hidden chart_description">Afdelingens procentvise andel af håndterede matches</p>
        </div>
        <div class="statistic_header_nav">
          <div></div>
          <div class="dropdown">
            <div class="select">
              <span class="select_span">Følsomhed</span>
              <i class="material-icons">
                keyboard_arrow_down
              </i>
            </div>
            <ul class="dropdown-menu">
              <li>Følsomhed</li>
              <li>Alle matches</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="doughnut_charts_container chart_container">
        <!-- Could be rewritten as for loop instead? -->
        <div class="doughnut_chart_container">
          <div>
            <canvas id="doughnut_chart_critical" width="100" height="100"></canvas>
          </div>
          <div class="doughnut_info_box">
            <h5>Kritisk</h5>
            <p>{{handled_matches.0.1}} af {{sensitivities.0.1}}</p>
            <!-- <p>+-x% sidste uge</p> -->
          </div>
        </div>
        <div class="doughnut_chart_container">
          <div>
            <canvas id="doughnut_chart_problem" width="100" height="100"></canvas>
          </div>
          <div class="doughnut_info_box">
            <h5>Problem</h5>
            <p>{{handled_matches.1.1}} af {{sensitivities.1.1}}</p>
            <!-- <p>+-x% sidste uge</p> -->
          </div>
        </div>
        <div class="doughnut_chart_container">
          <div>
            <canvas id="doughnut_chart_warning" width="100" height="100"></canvas>
          </div>
          <div class="doughnut_info_box">
            <h5>Advarsel</h5>
            <p>{{handled_matches.2.1}} af {{sensitivities.2.1}}</p>
            <!-- <p>+-x% sidste uge</p> -->
          </div>
        </div>
        <div class="doughnut_chart_container">
          <div>
            <canvas id="doughnut_chart_notification" width="100" height="100"></canvas>
          </div>
          <div class="doughnut_info_box">
            <h5>Notifikation</h5>
            <p>{{handled_matches.3.1}} af {{sensitivities.3.1}}</p>
            <!-- <p>+-x% sidste uge</p> -->
          </div>
        </div>
      </div>
      <div class="hidden chart_container">
        <div class="doughnut_chart_container">
          <div>
            <canvas id="doughnut_chart_total" width="100" height="100"></canvas>
          </div>
          <div class="doughnut_info_box">
            <h5>Håndterede matches</h5>
            <p>{{total_handled_matches}} af {{total_matches}}</p>
            <!-- <p>+-x% sidste uge</p> -->
          </div>
        </div>

      </div>
    </div>

    <!-- Line chart -->
    <div class="statistic statistic--four">
      <div class="statistic_header">
        <div class="">
          <h1 class="page-title__sub">Udviklingsoverblik</h1>
          <p class="chart_description">Antal nye matches pr. måned</p>
          <p class="hidden chart_description">Antal uhåndterede matches pr. måned</p>
        </div>
        <div class="statistic_header_nav">
          <div></div>
          <div class="dropdown">
            <div class="select">
              <span class="select_span">Nye matches pr. md.</span>
              <i class="material-icons">
                keyboard_arrow_down
              </i>
            </div>
            <ul class="dropdown-menu">
              <li>Nye matches pr. md.</li>
              <li>Uhåndterede matches</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="chart_container">
        <canvas id="line_chart_new_matches"></canvas>
      </div>
      <div class="hidden chart_container">
        <canvas id="line_chart_unhandled"></canvas>
      </div>
    </div>
  </div>
</div>


{{ sensitivities|json_script:"sensitivities" }}
{{ data_sources|json_script:"data_sources" }}
{{ handled_matches|json_script:"handled_matches" }}
{{ unhandled_matches|json_script:"unhandled_matches" }}
{{ oldest_match|json_script:"oldest_match" }}
<script>
  // json_script solution - Safe from in-page script execution
  const unhandledMatches = JSON.parse(document.getElementById('unhandled_matches').textContent);
  const oldestMatch = JSON.parse(document.getElementById('oldest_match').textContent);

  const sensitivities = JSON.parse(document.getElementById('sensitivities').textContent);
  const dataSources = JSON.parse(document.getElementById('data_sources').textContent);

  const handledMatches = JSON.parse(document.getElementById('handled_matches').textContent);

  const test = JSON.parse(document.getElementById('handled_matches').textContent);
  // Finds the total number matches in the array
  totalArrayValue = (array, index) => {
    let number = 0;
    for (let i = 0; i < array.length; i++) {
      number += array[i][index];
    }
    return number;
  };
  // Calculates the percentage for 'Håndterede matches -> Alle matches' 
  const totalMatches = totalArrayValue(sensitivities, 1)
  const totalHandledMatches = totalArrayValue(handledMatches, 1)
  const handledPercentage = totalHandledMatches / totalMatches  * 100;
  // To fixed decimal point
  handledPercentageFixed = handledPercentage.toFixed(1);



  // Might not be needed for the graphs
  // Calculates the four percentages in 'Håndterede matches -> Følsomhed'
  percentageArrayCalc = (fullArray, handledArray, decimals) => {
    let percentages = [];
    let percentage = 0;
    for (let i = 0; i < fullArray.length; i++) {
      // Handles one array being shorter then the other
      if (fullArray[i] != undefined && handledArray[i] != undefined) {
        percentage = handledArray[i][1] / fullArray[i][1] * 100;
        percentages[i] = percentage.toFixed(decimals);
      } else {
        percentages[i] = 0;
      }
    }
    // Returns an array
    return percentages;
  };

  // Returns the values of 'Xxx of xxx' for 'Håndterede matches'
  handledOfTotal = (fullArray, handledArray) => {
    handledOfTotalArray = [];
    for (let i = 0; i < fullArray.length; i++) {
      // Handles one array being shorter then the other
      if (fullArray[i] != undefined && handledArray[i] != undefined) {
        handledOfTotalArray[i] = `${handledArray[i][1]} of ${fullArray[i][1]}`; 
      } else {
        handledOfTotalArray[i] = '0 of 0';
      }
    }
      return handledOfTotalArray;
  };
</script>