<div class="content">
  <h1 class="page-title">Lederstatistik</h1>

  <div class="statistic_wrapper">
    <div class="statistic statistic--one">
      <h1 class="page-title__sub">Medarbejderoverblik</h1>
      <table class="datatable">
        <tr>
          {% for key, value in unhandled_matches %}
            <th>{{ key }}</th>
          {% endfor %}
        </tr>
        <tr>
          {% for key, value in unhandled_matches %}
            <td>{{ value }}</td>
          {% endfor %}
        </tr>
      </table>
      <table class="datatable">
          {% for key, value in oldest_match %}
            <th>{{ key }}</th>
          {% endfor %}
        </tr>
        <tr>
          {% for key, value in oldest_match %}
            <td>{{ value }} dage</td>
          {% endfor %}
        </tr>
      </table>
    </div>
  
    <div class="statistic statistic--two">
      <h1 class="page-title__sub">Fordeling af matches</h1>

      <p>Følsomhed</p>
      <table class="datatable">
        <tr>
          {% for key, value in sensitivities %}
            <th>{{ key }}</th>
          {% endfor %}
        </tr> 
        <tr>
          {% for key, value in sensitivities %}
          <td>{{ value }}</td>
          {% endfor %}
        </tr>
      </table>

      <p>Kilde</p>
      <table class="datatable">
        <tr>
          {% for key, value in data_sources %}
            <th>{{ key }}</th>
          {% endfor %}
        </tr>
        <tr>
          {% for key, value in data_sources %}
            <td>{{ value }}</td>
          {% endfor %}
        </tr>
      </table>
    </div>
  </div>

  <div class="statistic_wrapper">
    <div class="statistic statistic--three">
      <h1 class="page-title__sub">Håndterede matches</h1>
      <table class="datatable">
        <tr>
            <th>Total procent</th>
        </tr>
        <tr>
            <td><div id="total_handled_percentage"></div></td>
        </tr>
      </table>

      <p>Fordelt i følsomhed procent</p>
      <table class="datatable">
        <tr>
          {% for key, value in sensitivities %}
            <th>{{ key }}</th>
          {% endfor %}
        </tr>
        <tr id="handled_sensitivity_percentage"></tr>
        <tr id="handled_of_total"></tr>
      </table>
    </div>
  
    <div class="statistic statistic--four">
      <h1 class="page-title__sub">Udviklingsoverblik</h1>
    </div>
  </div>
</div>
{{ sensitivities|json_script:"sensitivities" }}
{{ data_sources|json_script:"data_sources" }}
{{ handled_matches|json_script:"handled_matches" }}
{{ unhandled_matches|json_script:"unhandled_matches" }}
{{ oldest_match|json_script:"oldest_match" }}
<script>
  // json_script solution - Safe from in-page script execution
  const sensitivities = JSON.parse(document.getElementById('sensitivities').textContent);
  const dataSources = JSON.parse(document.getElementById('data_sources').textContent);
  const handledMatches = JSON.parse(document.getElementById('handled_matches').textContent);
  const unhandledMatches = JSON.parse(document.getElementById('unhandled_matches').textContent);
  const oldestMatch = JSON.parse(document.getElementById('oldest_match').textContent);

  // Finds the total number matches in the array
  totalArrayValue = (array) => {
    let number = 0;
    for (let i = 0; i < array.length; i++) {
      number += array[i][1];
    }
    return number;
  };

  // Calculates the percentage for 'Håndterede matches -> Alle matches' 
  const totalMatches = totalArrayValue(sensitivities)
  const totalHandledMatches = totalArrayValue(handledMatches)
  const handledPercentage = totalHandledMatches / totalMatches  * 100;
  // To fixed decimal point
  handledPercentageFixed = handledPercentage.toFixed(1)

  // Might not be needed for the graphs
  // Calculates the four percentages in 'Håndterede matches -> Følsomhed'
  percentageArrayCalc = (fullArray, handledArray, decimals) => {
    let percentages = [];
    let percentage = 0;
    for (let i = 0; i < fullArray.length; i++) {
      // Handles one array being shorter then the other
      if (fullArray[i] != undefined && handledArray[i] != undefined) {
        percentage = handledArray[i][1] / fullArray[i][1] * 100;
        percentages[i] = percentage.toFixed(decimals);
      } else {
        percentages[i] = 0;
      }
    }
    // Returns an array
    return percentages;
  };

  // Returns the values of 'Xxx of xxx' for 'Håndterede matches'
  handledOfTotal = (fullArray, handledArray) => {
    handledOfTotalArray = [];
    for (let i = 0; i < fullArray.length; i++) {
      // Handles one array being shorter then the other
      if (fullArray[i] != undefined && handledArray[i] != undefined) {
        handledOfTotalArray[i] = `${handledArray[i][1]} of ${fullArray[i][1]}`; 
      } else {
        handledOfTotalArray[i] = '0 of 0';
      }
    }
      return handledOfTotalArray;
  };

  console.log(handledOfTotal(sensitivities, handledMatches));

  // TODO: Remove when done "prototyping"
  // Inserts 'Håndteret matches'-data
  htmlTableHandledMatches = () => {
    let tableRow = ''
    const sensitivitiesPercentage = percentageArrayCalc(sensitivities, handledMatches, 1);
    document.getElementById('total_handled_percentage').innerHTML = handledPercentageFixed + '%';
    for (let i = 0; i < sensitivitiesPercentage.length; i++) {
      tableRow += `<td>${sensitivitiesPercentage[i]}%</td>`;
    }
    document.getElementById('handled_sensitivity_percentage').innerHTML = tableRow;
  };

  htmlTableHandledMatches();

  // TODO: Remove when done "prototyping"
  // Inserts a table in the format 'array, dividing word, array'
  htmlTableInserter = (fullArray, handledArray, id, divider) => {
    let tableRow = '';
    for (let i = 0; i < fullArray.length; i++) {
      tableRow += `<td>${handledArray[i][1]} ${divider} ${fullArray[i][1]}</td>`;
    }
    document.getElementById(id).innerHTML = tableRow;
  };

  htmlTableInserter(sensitivities, handledMatches, 'handled_of_total', 'of')
</script>