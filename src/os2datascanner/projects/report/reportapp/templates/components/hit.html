{% load handle_extras %}
{% load i18n %}
{% load l10n %}
{% load humanize %}
{% load static %}

{% with type=document_report.matches.handle|find_type_label %}
  {% for frag in document_report.matches.matches %}
    {% if frag.rule.type_label in renderable_rules and frag.matches %}
    
      <tr data-type="{{ type }}"
      {% if last_open_pk and last_open_pk == document_report.pk|unlocalize %}
      class="highlighted"
      {% endif %}
      >
        <td class="datatable__column--checkbox">
          <div class="ds-checkbox">
            <input type="checkbox" 
                   id="table-checkbox-{{ document_report.pk|unlocalize }}" 
                   value="{{ document_report.pk|unlocalize }}" 
                   name="table-checkbox" 
                   class="datatable-checkbox" 
                   data-report-pk="{{ document_report.pk|unlocalize }}">
            <label for="table-checkbox-{{ document_report.pk|unlocalize }}">
              <span class="screen-reader-only">{% trans "Select result" %}</span>
            </label>
          </div>
        </td>

        <td class="datatable__column--name">
          <div class="tooltip">
            <div class="overflow-ellipsis">
              <strong data-tooltip-text>{{ document_report.matches.handle.presentation_name }}</strong>
            </div>
          </div>
          <div class="hit-link">
            <div class="button-group" name='open-button'
            hx-vals='{"pk": "{{ document_report.pk|unlocalize }}"}' 
            hx-get="" hx-swap="innerHTML" hx-target=".content" hx-trigger="click target:.btn-{{ document_report.pk|unlocalize }}"
            >
              {% if document_report.matches.handle|present_url %}
                <a href="{{ document_report.matches.handle|present_url }}" class="button btn-{{ document_report.pk|unlocalize }}" target="_blank" rel="noopener">
                  {% trans "Open" %}
                </a>
              {% endif %}
              {% if type != 'ews' and type != 'msgraph-mail-account' %}
                <button type="button" class="button btn-{{ document_report.pk|unlocalize }}" data-clipboard-text="{{ document_report.matches.handle|find_parent:type|present }}">
                  {% trans "Copy" %}
                </button>
                {% if document_report.matches.handle|find_parent:type|find_file_folder %}
                  <a href="{{ document_report.matches.handle|find_parent:type|find_file_folder }}" class="button btn-{{ document_report.pk|unlocalize }}" target="_blank" rel="noopener">
                    {% trans "Open folder" %}
                  </a>
                {% endif %}
              {% endif %}
            </div>
            {% if document_report.alias_relation.all and document_report.alias_relation.first.user != request.user %}
            <div class="delegated-by">
              {% trans "Delegated by: " %}{{ document_report.alias_relation.first.user.get_full_name }}
              <span title="{{ document_report.alias_relation.first.user.account.delegate_all_message }}">
                <img src="{% static "svg/question-circle.svg" %}">
              </span>
            </div>
            {% endif %}
            {% if document_report.last_opened_time %}
              {% with document_report.last_opened_time|naturaltime as time_since %}
              <div class='last-opened'>
                  {% trans "Opened" %} {{ time_since|capfirst }}.
              </div>
              {% endwith %}
            {% endif %}
          </div>
        </td>

        <td class="datatable__column--matchcount">
          {{ frag.matches|length }}
        </td>
                
        <td class="datatable__column--source">
          <span class="icon-filetype icon-filetype--{{ type }}" title="{% find_scan_type type %}">
          {% with svg_icon=type|find_svg_icon %}
            {% include svg_icon %}
          {% endwith %}
          </span>
        </td>

        {% comment %} path column {% endcomment%}
        <td class="datatable__column--path">
          <div class="tooltip">
            <div class="overflow-ellipsis">
              <span data-tooltip-text>{{ document_report.matches.handle.presentation_place }}</span>
            </div>
          </div>
        </td>

        <td class="datatable__column--actions">
          <div class="button-group text-align-right">
            <button class="matches-handle button button--has-icon" type="button"
                    title="{% blocktrans %}OS2datascanner will not delete results from the system that was scanned.
Marking a result as handled will only remove the result from OS2datascanner.{% endblocktrans %}"
                    hx-post="{% url "content" %}"
                    hx-swap="outerHTML"
                    hx-target="closest tr"
                    hx-indicator="closest tr"
                    hx-trigger="click"
                    hx-push-url="false"
                    hx-sync=".datatable-wrapper:replace"
                    hx-vals='{"pk":"{{ document_report.pk|unlocalize }}"}'
                    {% if request.user.account.time_since_last_handle > 172800 %}
                      hx-confirm="{% trans 'You are about to handle this result. This action does not change the file, that the result is about. Please do not handle a result before action has been manually taken to the file.' %}"
                    {% endif %}
                    name="handle-match">
                <i class="material-icons text-secondary" aria-hidden="true">archive</i> <span>{% trans "Handle" %}</span></button>
            <button class="matches-expand button button-caret button--has-icon" title="{% trans 'Show/hide matches' %}" type="button"><i class="material-icons" aria-hidden="true">expand_more</i></button>
          </div>
        </td>
      </tr>
      <tr class="matches-list" hidden>
        <td colspan="6">
          <table class="smaller datatable compressed">
            <colgroup>
              <col class="matches-list__column--match">
              <col class="matches-list__column--context">
              <col class="matches-list__column--probability" hidden>
            </colgroup>
            <thead>
              <th>{% trans "Anonymized match" %}</th>
              <th>{% trans "Context" %}</th>
              <th class="text-align-right matches-list__column--probability" hidden>{% trans "Probability" %}</th>
            </thead>
            <tbody>
            {% with document_report.pk as pk %}
            {% with None as interval %}
              {% include "components/matches_table.html" %}
            {% endwith %}
            {% endwith %}
            </tbody>
          </table>
        </td>
      </tr>
    {% endif %}
  {% endfor %}
{% endwith %}